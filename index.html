<!doctype html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="靖哥哥的技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="欢迎光临我的技术博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="欢迎光临我的技术博客">
<meta property="og:description" content="靖哥哥的技术博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="欢迎光临我的技术博客">
<meta name="twitter:description" content="靖哥哥的技术博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>欢迎光临我的技术博客</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">欢迎光临我的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">吹一吹</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/15/spark-map-flatmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/15/spark-map-flatmap/" itemprop="url">
                  spark map flatmap区别联系
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-15T15:16:24+08:00">
                2017-08-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/15/spark-map-flatmap/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/15/spark-map-flatmap/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>spark中map是一对一的变换，也就是一个元素经过map变换后还是一个元素，而flatMap是扁平化变换也就是一对多变化，flatMap返回的是一个array,但输出到下个变换时，会把array拆成多个单元素来处理，下面举一个例子</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">scala&gt; <span class="keyword">val</span> bb = sc.textFile(<span class="string">"/home/user/liqing.zhan/bb"</span>)</div><div class="line">scala&gt; bb.collect.foreach(println)</div><div class="line"></div><div class="line">abc</div><div class="line">dd aa cc de er ad as d s as  d  d sdf as d</div><div class="line">df</div><div class="line">sa</div><div class="line">dd ee e d g a ew sa</div><div class="line">df</div><div class="line"></div><div class="line">scala&gt; bb.map(_.split(<span class="string">" "</span>)).collect.foreach(println)</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">3</span>ad9f06a</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">72</span>cb5d7d</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">19</span>b89a23</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">6</span>d1a4522</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">1835</span>b24b</div><div class="line">[<span class="type">Ljava</span>.lang.<span class="type">String</span>;@<span class="number">303</span>d2485</div><div class="line"></div><div class="line">scala&gt; bb.flatMap(_.split(<span class="string">"\\w+"</span>)).collect.foreach(println)</div><div class="line"></div><div class="line">abc</div><div class="line">dd</div><div class="line">aa</div><div class="line">cc</div><div class="line">de</div><div class="line">er</div><div class="line">ad</div><div class="line">as</div><div class="line">d</div><div class="line">s</div><div class="line">as</div><div class="line">d</div><div class="line">d</div><div class="line">sdf</div><div class="line">as</div><div class="line">d</div><div class="line">df</div><div class="line">sa</div><div class="line">dd</div><div class="line">ee</div><div class="line">e</div><div class="line">d</div><div class="line">g</div><div class="line">a</div><div class="line">ew</div><div class="line">sa</div><div class="line">df</div><div class="line"></div><div class="line">word count</div><div class="line">scala&gt; bb.flatMap(_.split(<span class="string">"\\W+"</span>)).map(line=&gt;(line,<span class="number">1</span>)).reduceByKey(_+_).sortByKey().collect.foreach(println)</div><div class="line"></div><div class="line">a.map(_.split(<span class="string">","</span>)).map(item =&gt; (<span class="string">s"<span class="subst">$&#123;item(0)&#125;</span>-<span class="subst">$&#123;item(1)&#125;</span>"</span>, item(<span class="number">2</span>))).groupByKey.map(item =&gt; (item._1, item._2.toList.sortWith(_.toInt&lt;_.toInt))).flatMap(item=&gt;item._2.map(x=&gt;(item._1,x))).collect.foreach(println)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/31/mysql-row-colome-transpose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/31/mysql-row-colome-transpose/" itemprop="url">
                  mysql row colome transpose
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-31T11:01:21+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/31/mysql-row-colome-transpose/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/31/mysql-row-colome-transpose/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CREATE TABLE score ( NAME CHAR(10), course CHAR(10), score INT )</p>
<p>INSERT INTO score VALUES(‘张三’,‘语文’,80); INSERT INTO score VALUES(‘张三’,‘数学’,81); INSERT INTO score VALUES(‘张三’,‘英语’,82); INSERT INTO score VALUES(‘张三’,‘化学’,83); INSERT INTO score VALUES(‘李四’,‘语文’,80); INSERT INTO score VALUES(‘李四’,‘数学’,81); INSERT INTO score VALUES(‘李四’,‘英语’,82); INSERT INTO score VALUES(‘王五’,‘数学’,83); INSERT INTO score VALUES(‘王五’,‘英语’,80);</p>
<p>SELECT * FROM score</p>
<p>SELECT NAME , SUM(IF(course=“语文”,score,0)) AS ‘语文’, SUM(IF(course=‘数学’,score,0)) AS ‘数学’, SUM(IF(course=‘英语’,score,0)) AS ‘英语’, SUM(IF(course=‘化学’,score,0)) AS ‘化学’ FROM score GROUP BY NAME</p>
<p>SELECT NAME , SUM(CASE course WHEN ‘语文’ THEN score ELSE 0 END) AS ‘语文’, SUM(CASE course WHEN ‘数学’ THEN score ELSE 0 END) AS ‘数学’, SUM(CASE course WHEN ‘英语’ THEN score ELSE 0 END) AS ‘英语’, SUM(CASE course WHEN ‘化学’ THEN score ELSE 0 END) AS ‘化学’ FROM score GROUP BY NAME</p>
<p>SELECT NAME , MAX(CASE course WHEN ‘语文’ THEN score ELSE 0 END) AS ‘语文’, MAX(CASE course WHEN ‘数学’ THEN score ELSE 0 END) AS ‘数学’, MAX(CASE course WHEN ‘英语’ THEN score ELSE 0 END) AS ‘英语’, MAX(CASE course WHEN ‘化学’ THEN score ELSE 0 END) AS ‘化学’ FROM score GROUP BY NAME</p>
<p>UPDATE score SET teacher=‘张三_语文老师’ WHERE NAME=‘张三’ AND course=‘语文’; UPDATE score SET teacher=‘张三_数学老师’ WHERE NAME=‘张三’ AND course=‘数学’; UPDATE score SET teacher=‘张三_英语老师’ WHERE NAME=‘张三’ AND course=‘英语’; UPDATE score SET teacher=‘张三_化学老师’ WHERE NAME=‘张三’ AND course=‘化学’; UPDATE score SET teacher=‘李四_语文老师’ WHERE NAME=‘李四’ AND course=‘语文’; UPDATE score SET teacher=‘李四_数学老师’ WHERE NAME=‘李四’ AND course=‘数学’; UPDATE score SET teacher=‘李四_英语老师’ WHERE NAME=‘李四’ AND course=‘英语’; UPDATE score SET teacher=‘王五_数学老师’ WHERE NAME=‘王五’ AND course=‘数学’; UPDATE score SET teacher=‘王五_英语老师’ WHERE NAME=‘王五’ AND course=‘英语’;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/11/gradient-boost-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/11/gradient-boost-machine/" itemprop="url">
                  gradient boost machine理解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-11T18:47:10+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/11/gradient-boost-machine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/11/gradient-boost-machine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/07/logloss-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/07/logloss-function/" itemprop="url">
                  log loss及sigmoid函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-07T22:41:31+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/07/logloss-function/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/07/logloss-function/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>sigmoid是一个S型函数，它的函数图像如下</p>
<center>
<img src="../img/sigmoid_pic.jpg">
</center>
<p>可以看到他是一个单调递增函数，值域是[0,1]，函数定义为 <span class="math display">\[
f(t)=\frac1{1+e^{-t}}  \tag{1}
\]</span> 在机器学习中，sigmoid常作为激活函数或者非线性变换函数，首先看看它的导数 <span class="math display">\[
f&#39;(t)=(\frac1{1+e^{-t}})&#39;=\frac{1}{1+e^{-t}}*\frac{e^{-t}}{1+e^{-t}}=(1-f(t))f(t)    \tag{2}
\]</span> 再来看看它的其他性质 <span class="math display">\[f(-t)=\frac1{1+e^{t}}=\frac{e^t}{1+e^{-t}}=1-f(t) \tag{3}\]</span> <span class="math display">\[\Rightarrow f(t)+f(-t)==1\]</span></p>
<p>因为它的值域是[0,1]，因此这个函数常用来定义概率分布函数，对于分类问题，如果定义属于某个类别的概率是<span class="math inline">\(f(x)\)</span>，则可以用极大似然估计来求得参数值，例如对于二分类，假设<span class="math inline">\(y\in(0,1)\)</span>，则似然函数为 <span class="math display">\[S(x)=f(x)^y(1-f(x))^{1-y} \tag{4}\]</span> 对似然函数取log后得 <span class="math display">\[log(S(x))=ylog(f(x))+(1-y)log(1-f(x)) \tag{5}\]</span>，化简得</p>
<p><span class="math display">\[log(S(x))=ylog(f(x))+(1-y)log(1-f(x)) \]</span> <span class="math display">\[\Rightarrow log(S(x))=y[log(f(x))-log(1-f(x))] + log(1-f(x)) \tag{6}\]</span> <span class="math display">\[\Rightarrow log(S(x))=ylog(\frac {f(x)}{1-f(x)})+ log(1-f(x)) \tag{7} \]</span> <span class="math display">\[\Rightarrow log(S(x))=yw^Tx-log(1+e^{w^Tx}) \tag{8}\]</span></p>
<p>而如果假设<span class="math inline">\(y\in(-1,1)\)</span>，则有<span class="math inline">\(\frac{1+y}{2}\in(0,1)\)</span>，同理有 <span class="math display">\[log(S(x))=\frac{1+y}{2}w^Tx-log(1+e^{w^Tx}) \tag{9}\]</span> 如果<span class="math inline">\(y=1\)</span>，则有 <span class="math display">\[log(S(x))=w^Tx-log(1+e^{w^Tx})=-log(1+e^{-w^Tx})  \tag{10}\]</span> 如果<span class="math inline">\(y=-1\)</span>，则有 <span class="math display">\[log(S(x))=-log(1+e^{w^Tx}) \tag{11}\]</span> 因此，损失对数损失函数可以写为 <span class="math display">\[log(S(x))=-log(1+e^{-yw^Tx}) \tag{12}\]</span></p>
<p>对于<span class="math inline">\(y\in(0,1)\)</span>和<span class="math inline">\(y\in(-1,1)\)</span>损失函数的形式，也可以这样推导 首先对于<span class="math inline">\(y\in(0,1)\)</span>，有概率公式 <span class="math display">\[
\begin{aligned}
\mathbb{P}(y=1|z) &amp; =\sigma(z)=\frac{1}{1+e^{-z}}\\
\mathbb{P}(y=0|z) &amp; =1-\sigma(z)=\frac{1}{1+e^{z}}\\
\end{aligned} \tag{13}
\]</span></p>
<p>如果不考虑y的取值，可以写成 <span class="math display">\[\mathbb{P}(y|z)  =\sigma(z)^y(1-\sigma(z))^{1-y} \tag{14}\]</span> 而由于sigmoid的性质，<span class="math inline">\(1-\sigma(z)=\sigma(-z)\)</span>，因此，如果<span class="math inline">\(y\in(-1,1)\)</span>，在不考虑y的取值时，概率分布函数可以写成 <span class="math display">\[
\mathbb{P}(y|z)=\sigma(yz) \tag{15}
\]</span> 即概率分布函数可以写成 <span class="math display">\[\mathbb{P}(y|z)  =\frac{1}{1+e^{-yz}} \tag{16}\]</span></p>
<h2 id="softmax对应的概率公式及求导">softmax对应的概率公式及求导</h2>
<p>上边说的logloss是二分类的损失函数，也就是逻辑回归用的损失函数，而对于多分类的情形，需要用softmax，相应的概率密度函数也要做相应的修改，如下： 假设分类为<span class="math inline">\(m\)</span>类，对于每一类有一个<span class="math inline">\(n\)</span>维的参数，即对于<span class="math inline">\(Y=k\)</span>，它的参数为<span class="math inline">\(w_{k1},w_{k2},\cdots,w_{kn}\)</span>，则定义它的概率密度函数为：</p>
<p><span class="math display">\[\mathbb{P}(Y=j|x) = \frac{e^{W_jX}}{\sum_{i=1}^{m}e^{W_iX}}\]</span>，其中<span class="math display">\[W_jX=w_{j1}x_1+w_{j2}x_2+\cdots+w_{jn}x_n\]</span>， 对于softmax，通常用logloss损失函数，公式为 <span class="math display">\[L(y,y&#39;)=\sum_{1}^{m}{-y_{i}log(y’_{i})}\]</span> y为<span class="math inline">\((m,1)\)</span>的列向量，假设一个样本为i类，则<span class="math inline">\(y=[0,0,\cdots,1,\cdots,0]\)</span>,第<span class="math inline">\(i\)</span>维为1</p>
<p>下面讨论导数,假设样本为<span class="math inline">\(i\)</span>类，则有对于<span class="math inline">\(j=i\)</span>，求导得 <span class="math display">\[
f&#39;(W_jX)=-\frac{1}{f(W_iX)}\frac{\partial_{\mathbb{P}(Y=j|x)}}{\partial_{Wj}}
=-\frac{1}{f(W_iX)}(\frac{e^{W_jX}*X}{\sum_{i=1}^{k}e^{W_{i}X}}-\frac{e^{W_jX}*e^{W_jX}*X}{\left (\sum_{i=1}^{k}e^{W_iX} \right)^2})
=(f(W_jX-1)X
\]</span> 而对于<span class="math inline">\(j != i\)</span>的情况， <span class="math display">\[
f&#39;(W_jX)=-\frac{1}{f(W_iX)}\frac{\partial_{\mathbb{P}(Y=i|x)}}{\partial_{Wj}}
=-\frac{1}{f(W_iX)}(-\frac{e^{W_jX}*e^{W_iX}*X}{\left (\sum_{i=1}^{k}e^{W_iX} \right)^2})
=f(W_jX)X
\]</span> 我们注意到<span class="math inline">\(y_i=1,y_j=0\)</span>,因此可以写成通用的格式，即 <span class="math display">\[
f&#39;(W_iX)=(f(W_iX)-y_i)X
\]</span> 可以看到，跟二分类的逻辑回归是一致的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/26/install-lightgbm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/26/install-lightgbm/" itemprop="url">
                  编译安装微软开源lightgbm工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-26T15:37:58+08:00">
                2017-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/26/install-lightgbm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/26/install-lightgbm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>lightgbm在Linux下安装需要glibc&gt;=2.14，大部分centos系统默认的安装版本是glibc=2.12。因此，要想再上边安装，就需要升级glibc，我们知道glibc是一个很底层的调用库，升级之后容易出现很多错误。一个安全的安装方法是，我在系统上边安装多个glibc版本呢，在编译运行lightgbm的时候用新的版本glibc，因为lightgbm使用了c++11的一些特性，通常情况下也需要升级gcc编译器，同样可以安装多个版本的gcc编译器，下面是我的操作过程： 1、下载gcc和glibc的源码，编译，过程在网上搜一下，需要注意的是，编译的时候指定prefix为你要安装的目录，不要覆盖系统上的已有的，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make prefix=/home/q/users/liqing.zhan/gcc/ install</div></pre></td></tr></table></figure>
<p>2、设置LD_LIBRARY_PATH</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export LD_LIBRARY_PATH=/home/q/users/liqing.zhan/lib:/home/q/users/liqing.zhan/gcc/lib64/:/lib64/</div></pre></td></tr></table></figure>
<p>这里说一下LD_LIBRARY_PATH和LIBRARY_PATH的区别，这两个都linux的环境变量，LIBRARY_PATH环境变量用于在程序编译期间查找动态链接库时指定查找共享库的路径，例如，指定gcc编译需要用到的动态链接库的目录。设置方法如下（其中，LIBDIR1和LIBDIR2为两个库目录）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export LIBRARY_PATH=LIBDIR1:LIBDIR2:$LIBRARY_PATH</div></pre></td></tr></table></figure>
<p>LD_LIBRARY_PATH环境变量用于在程序加载运行期间查找动态链接库时指定除了系统默认路径之外的其他路径，注意，LD_LIBRARY_PATH中指定的路径会在系统默认路径之前进行查找。设置方法如下（其中，LIBDIR1和LIBDIR2为两个库目录）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export LD_LIBRARY_PATH=LIBDIR1:LIBDIR2:$LD_LIBRARY_PATH</div></pre></td></tr></table></figure>
<p>https://stackoverflow.com/questions/4250624/ld-library-path-vs-library-path<br>
https://typecodes.com/cseries/gcclderrlibrarypath.html</p>
<p>如果用export来设置，只是当前回话有效的，可以在~/.bash_profile下设置</p>
<p>3、设置gcc和g++的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export CC=/usr/local/bin/gcc</div><div class="line">export CXX=/usr/local/bin/g++</div></pre></td></tr></table></figure>
<p>https://stackoverflow.com/questions/17275348/how-to-specify-new-gcc-path-for-cmake<br>
https://stackoverflow.com/questions/11588855/how-do-you-set-cmake-c-compiler-and-cmake-cxx-compiler-for-building-assimp-for-i</p>
<p>4、编译lightgbm</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/22/libc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/22/libc/" itemprop="url">
                  误删linux下的libc.so.6
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-22T17:30:01+08:00">
                2017-06-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/22/libc/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/22/libc/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天想装一个软件，由于这个软件需要依赖glibc&gt;=2.14，当前系统的glibc最大是2.12，所以就下载源码、编译升级了，然后就在命令行下执行了如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo mv /lib64/libc.so.6 /lib64/libc.so.6.bak</div><div class="line">sudo ln -s /lib64/libc-2.14.so /lib64/libc.so.6</div><div class="line"></div><div class="line">结果报错：</div><div class="line">error while loading shared libraries: libc.so.6: cannot open shared object file: No such file or directory</div></pre></td></tr></table></figure>
<p>此时，大部分的命令都执行不了了，只能执行一些简单的如，cd 等命令，而且ssh也没法登陆了，如果你是远程ssh登陆的服务器，执行完上边的命令后，链接还是存在的，如果是以root用户登陆的，则很好回复，只需要用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LD_PRELOAD=/lib64/libc-2.14.so ln -s libc-2.14.so libc.so.6</div></pre></td></tr></table></figure>
<p>就可以建立软连接了，原理就是linux调用so的库文件时，搜素路径为当前路径，再是系统lib目录。但如果设置LD_PRELOAD了后,库加载的顺序就改为LD_PRELOAD ，当前路径，再是系统lib目录。</p>
<p>或者可以执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ldconfig</div></pre></td></tr></table></figure>
<p>来恢复，他会重新建一个软连接，来链接你重命名的那个软链 参考https://stackoverflow.com/questions/12249547/how-to-recover-after-deleting-the-symbolic-link-libc-so-6 如果不是root用户，就乖乖的用光盘修复吧，暂时没查到相关的修复方法 https://superuser.com/questions/267096/how-to-restore-lib-libc-so-6</p>
<p>http://wbwk2005.blog.51cto.com/2215231/415185</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/24/merge-small-file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/24/merge-small-file/" itemprop="url">
                  hdfs小文件合并存在的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-24T22:58:28+08:00">
                2017-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/24/merge-small-file/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/24/merge-small-file/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在hdfs中，如果存在很多小文件，不但浪费存储空间，而且占用大量namenode的内存，一种可行的方案是把小文件合并为一个大文件，今天就说一下合并小文件经历的问题</p>
<p>如果在hdfs中有很多gzip压缩的小文件，合并可以通过一个mr程序来实现，把reduce的个数设置为一个远小于输入文件的个数，但可能会有一个比较奇怪的现象，就是合并后的文件大小跟合并前文件大小不一致，为什么呢，没研究过gzip算法，我猜测gzip压缩可能会联系上下文信息进行压缩，也就是如果相邻行相同的内容挨在一起，压缩比率会更大，做个小实验</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span>  test cat g_log.sh</div><div class="line">line=`seq 1 1000000`</div><div class="line"></div><div class="line">chars=("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" \</div><div class="line">       "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb" \</div><div class="line">       "ccccccccccccccccccccccccccccccccccccccc" \</div><div class="line">       "ddddddddddddddddddddddddddddddddddddddd" \</div><div class="line">       "eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee" \</div><div class="line">       "fffffffffffffffffffffffffffffffffffffff" \</div><div class="line">       "ggggggggggggggggggggggggggggggggggggggg")</div><div class="line"></div><div class="line">echo $&#123;#chars[@]&#125;</div><div class="line"></div><div class="line">for i in $line ;do</div><div class="line">    id=$(($RANDOM%7))</div><div class="line">    echo $&#123;chars[$id]&#125;,$i,$id &gt;&gt;tmp</div><div class="line">done</div><div class="line"><span class="meta">$</span>  test ll tmp</div><div class="line">-rw-rw-r--. 1 zlq zlq 47M Apr 24 23:27 tmp	</div><div class="line"><span class="meta"></span></div><div class="line">$  test cat tmp|gzip &gt;tmp.gz</div><div class="line"><span class="meta">$</span>  test cat tmp|sort|gzip &gt;tmp1.gz</div><div class="line"><span class="meta">$</span>  test ll</div><div class="line">-rw-rw-r--. 1 zlq zlq  480 Apr 24 23:26 g_log.sh</div><div class="line">-rw-rw-r--. 1 zlq zlq  47M Apr 24 23:27 tmp</div><div class="line">-rw-rw-r--. 1 zlq zlq 2.9M Apr 24 23:28 tmp1.gz</div><div class="line">-rw-rw-r--. 1 zlq zlq 3.5M Apr 24 23:28 tmp.gz</div></pre></td></tr></table></figure>
<p>可以看到排序后的压缩更高，因此多个小文件合并，如果直接进行repartition，则压缩前后大小不一致，如果源文件是相同key的在一起，则重排后可能文件大小可能会变大，一种办法是在map中分key写，但这样程序不通用，在spark中有一个变化叫coalesce，他不会引起数据的repartition，因此可以用他来实现文件合并，事例代码如下</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span></div><div class="line"><span class="keyword">import</span> java.util.<span class="type">Calendar</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.compress.<span class="type">GzipCodec</span></div><div class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * Created by liqing.zhan on 2017/4/24.</div><div class="line">  */</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">SmallFileMerge</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"merge_small_file"</span>)</div><div class="line">        <span class="keyword">val</span> context: <span class="type">SparkContext</span> = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</div><div class="line">        <span class="keyword">var</span> start = args(<span class="number">0</span>).toInt</div><div class="line">        <span class="keyword">val</span> end = args(<span class="number">1</span>).toInt</div><div class="line"></div><div class="line">        <span class="keyword">val</span> path = args(<span class="number">2</span>)</div><div class="line"></div><div class="line">        <span class="keyword">val</span> partitions = args(<span class="number">3</span>).toInt</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (end &lt; start) <span class="keyword">return</span></div><div class="line"></div><div class="line">        do &#123;</div><div class="line">            <span class="keyword">val</span> sc = context.textFile(path + <span class="string">"/"</span> + start)</div><div class="line">            sc.coalesce(partitions).saveAsTextFile(path + <span class="string">"/"</span> + start + <span class="string">"_bak"</span>, classOf[<span class="type">GzipCodec</span>])</div><div class="line">            println(<span class="string">"process %s"</span>.format(start))</div><div class="line">            start = addDate(start, <span class="number">1</span>)</div><div class="line">        &#125; <span class="keyword">while</span> (start &lt;= end)</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addDate</span></span>(day: <span class="type">Int</span>, c: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</div><div class="line">        <span class="keyword">val</span> dateFormat: <span class="type">SimpleDateFormat</span> = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">"yyyyMMdd"</span>)</div><div class="line">        <span class="keyword">val</span> day1 = dateFormat.parse(day + <span class="string">""</span>)</div><div class="line">        <span class="keyword">val</span> cal: <span class="type">Calendar</span> = <span class="type">Calendar</span>.getInstance</div><div class="line">        cal.setTime(day1)</div><div class="line">        cal.add(<span class="type">Calendar</span>.<span class="type">DAY_OF_MONTH</span>, c)</div><div class="line">        dateFormat.format(cal.getTime).toInt</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="借助combinefileinputformat">借助CombineFileInputFormat</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 合并小文件工具，依赖CombineFileInputFormat类</div><div class="line"> * 传入三个参数，</div><div class="line"> * args1:合并文件的最大值，如果用gzip压缩，设置大点，1000M左右</div><div class="line"> * args2:input path</div><div class="line"> * args3:output path</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Created by liqing.zhan on 2017/5/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSmallFile</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(MergeSmallFile.class);</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MB = <span class="number">1024</span> * <span class="number">1024L</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> exitCode = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            exitCode = ToolRunner.run(<span class="keyword">new</span> MergeSmallFile(), args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            log.error(<span class="string">"merge small file exception "</span>, e);</div><div class="line">        &#125;</div><div class="line">        System.exit(exitCode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Configuration conf = <span class="keyword">new</span> Configuration(getConf());</div><div class="line">        <span class="keyword">int</span> maxSize = Integer.parseInt(args[<span class="number">0</span>]);</div><div class="line">        conf.setLong(<span class="string">"mapreduce.input.fileinputformat.split.maxsize"</span>, MB * maxSize);</div><div class="line">        conf.setBoolean(<span class="string">"mapred.output.compress"</span>, <span class="keyword">true</span>);</div><div class="line">        conf.setClass(<span class="string">"mapred.output.compression.codec"</span>, GzipCodec.class, CompressionCodec.class);</div><div class="line">        conf.set(<span class="string">"mapred.job.queue.name"</span>, <span class="string">"yourqueue"</span>);</div><div class="line">        conf.set(<span class="string">"mapred.job.priority"</span>, JobPriority.VERY_HIGH.name());</div><div class="line">        conf.set(<span class="string">"mapreduce.task.timeout"</span>, <span class="string">"6000000"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        Job job = Job.getInstance(conf);</div><div class="line">        job.setJobName(<span class="string">"merge_smallfile.liqing.zhan"</span>);</div><div class="line">        FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">2</span>]));</div><div class="line">        job.setJarByClass(MergeSmallFile.class);</div><div class="line">        job.setInputFormatClass(CombineTextInputFormat.class);</div><div class="line">        job.setMapOutputKeyClass(NullWritable.class);</div><div class="line">        job.setOutputValueClass(Text.class);</div><div class="line">        job.setOutputFormatClass(TextOutputFormat.class);</div><div class="line">        job.setOutputKeyClass(NullWritable.class);</div><div class="line">        job.setOutputValueClass(Text.class);</div><div class="line">        job.setMapperClass(PureMapper.class);</div><div class="line">        job.setNumReduceTasks(<span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PureMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">            context.write(NullWritable.get(), value);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有一个问题，如果小文件是hive的数据源，并且hive的表结构中途增加过字段，则用add partition增加分区后，查询输出的内容可能不一致。</p>
<p>例如假设有如下建表语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> <span class="string">`test_zz`</span>(</div><div class="line">  <span class="string">`a1`</span> <span class="keyword">string</span>, </div><div class="line">  <span class="string">`a2`</span> <span class="keyword">string</span>, </div><div class="line">  <span class="string">`a3`</span> <span class="keyword">string</span>)</div><div class="line">PARTITIONED <span class="keyword">BY</span> ( </div><div class="line">  <span class="string">`day`</span> <span class="built_in">int</span>)</div><div class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </div><div class="line">  <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span> </div><div class="line">  <span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span> </div><div class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> INPUTFORMAT </div><div class="line">  <span class="string">'org.apache.hadoop.mapred.TextInputFormat'</span> </div><div class="line">OUTPUTFORMAT </div><div class="line">  <span class="string">'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'</span></div><div class="line">LOCATION</div><div class="line">  <span class="string">'hdfs://abc/liqing.zhan/hive'</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/13/matrix-decomposition-application-in-recommand-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/13/matrix-decomposition-application-in-recommand-system/" itemprop="url">
                  推荐算法简介及矩阵分解在推荐系统中的应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-13T18:53:21+08:00">
                2017-04-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/推荐系统/" itemprop="url" rel="index">
                    <span itemprop="name">推荐系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/13/matrix-decomposition-application-in-recommand-system/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/13/matrix-decomposition-application-in-recommand-system/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介">简介</h2>
<p>推荐算法是推荐系统的核心，推荐算法可以分为如下几类:</p>
<ul>
<li>基于内容的推荐<br>
</li>
<li>基于协同过滤推荐<br>
</li>
<li>基于关联规则的推荐<br>
</li>
<li>混合推荐</li>
</ul>
<h5 id="基于内容的推荐">基于内容的推荐</h5>
<p>基于内容推荐(Content-based Recommendations)是很早的一种推荐方法，他是基于item特征和用户profile来建模，也就是根据item基础属性及历史数据抽取item的行为特征，根据用户历史行为数据（例如评价、分享、点赞等行为）抽取用户的profile数据，然后根据item和用户特征，为用户推荐一组相关性最大的item。</p>
<p><a href="http://www.cnblogs.com/breezedeus/archive/2012/04/10/2440488.html" target="_blank" rel="external">举个例子</a> ,对于个性化阅读来说，一个item就是一篇文章。根据上面的第一步，我们首先要从文章内容中抽取出代表它们的属性。常用的方法就是利用出现在一篇文章中词来代表这篇文章，而每个词对应的权重往往使用信息检索中的tf-idf来计算。比如对于本文来说，词“CB”、“推荐”和“喜好”的权重会比较大，而“烤肉”这个词的权重会比较低。利用这种方法，一篇抽象的文章就可以使用具体的一个向量来表示了。第二步就是根据用户过去喜欢什么文章来产生刻画此用户喜好的 profile了，最简单的方法可以把用户所有喜欢的文章对应的向量的平均值作为此用户的profile。比如某个用户经常关注与推荐系统有关的文章，那么他的profile中“CB”、“CF”和“推荐”对应的权重值就会较高。在获得了一个用户的profile后，CB就可以利用所有item与此用户profile的相关度对他进行推荐文章了。一个常用的相关度计算方法是cosine。最终把候选item里与此用户最相关（cosine值最大）的N个item作为推荐返回给此用户。举个例子说明前面的三个步骤。对于个性化阅读来说，一个item就是一篇文章。根据上面的第一步，我们首先要从文章内容中抽取出代表它们的属性。常用的方法就是利用出现在一篇文章中词来代表这篇文章，而每个词对应的权重往往使用信息检索中的tf-idf来计算。比如对于本文来说，词“CB”、“推荐”和“喜好”的权重会比较大，而“烤肉”这个词的权重会比较低。利用这种方法，一篇抽象的文章就可以使用具体的一个向量来表示了。第二步就是根据用户过去喜欢什么文章来产生刻画此用户喜好的 profile了，最简单的方法可以把用户所有喜欢的文章对应的向量的平均值作为此用户的profile。比如某个用户经常关注与推荐系统有关的文章，那么他的profile中“CB”、“CF”和“推荐”对应的权重值就会较高。在获得了一个用户的profile后，CB就可以利用所有item与此用户profile的相关度对他进行推荐文章了。一个常用的相关度计算方法是cosine。最终把候选item里与此用户最相关（cosine值最大）的N个item作为推荐返回给此用户。</p>
<p>有了特征，就可以应用监督学习来学习一个模型，使用这个模型对item进行打分，选出最大的几个item来作为推荐结果，大部分监督学习算法都可以应用到这里，如线性回归，逻辑回归，决策树等</p>
<h5 id="基于协同过滤推荐">基于协同过滤推荐</h5>
<p>协同过滤（ CF）推荐算法通过在用户活动中寻找特定模式来为用户产生有效推荐。它依赖于系统中用户的惯用数据，例如通过用户对其阅读过书籍的评价可以推断出用户的阅读偏好。这种算法的核心思想就是：如果两个用户对于一些项的评分相似程度较高，那么一个用户对于一个新项的评分很有可能类似于另一个用户。值得注意的是，他们推荐的时候不依赖于项的任何附加信息（ 例如描述、元数据等等）或者用户的任何附加信息（例如喜好、人口统计相关数据等等）。 CF 的方法大体可分为两类：分别为邻域和基于模型的方法。邻域方法（即基于内存的 CF）是使用用户对已有项的评分直接预测该用户对新项的评分。与之相反，基于模型的方法是使用历史评分数据，基于学习出的预测模型，预测对新项的评分。通常的方式是使用机器学习算法，找出用户与项的相互作用模型，从而找出数据中的特定模式。</p>
<h5 id="基于关联规则的推荐">基于关联规则的推荐</h5>
<p>基于关联规则的推荐（Association Rule-based Recommendation）是以关联规则为基础，把已购商品作为规则头，规则体为推荐对象。关联规则挖掘可以发现不同商品在销售过程中的相关性，在零售业中已经得到了成功的应用。管理规则就是在一个交易数据库中统计购买了商品集X的交易中有多大比例的交易同时购买了商品集Y，其直观的意义就是用户在购买某些商品的时候有多大倾向去购买另外一些商品。比如购买牛奶的同时很多人会同时购买面包。 #####混合推荐##### <a href="http://blog.sina.com.cn/s/blog_602feaa80100fjq9.html" target="_blank" rel="external">由于各种推荐方法</a>都有优缺点，所以在实际中，组合推荐（Hybrid Recommendation）经常被采用。研究和应用最多的是内容推荐和协同过滤推荐的组合。最简单的做法就是分别用基于内容的方法和协同过滤推荐方法去产生一个推荐预测结果，然后用某方法组合其结果。尽管从理论上有很多种推荐组合方法，但在某一具体问题中并不见得都有效，组合推荐一个最重要原则就是通过组合后要能避免或弥补各自推荐技术的弱点。 在组合方式上，有研究人员提出了七种组合思路： 1）加权（Weight）：加权多种推荐技术结果。 2）变换（Switch）：根据问题背景和实际情况或要求决定变换采用不同的推荐技术。 3）混合（Mixed）：同时采用多种推荐技术给出多种推荐结果为用户提供参考。 4）特征组合（Feature combination）：组合来自不同推荐数据源的特征被另一种推荐算法所采用。 5）层叠（Cascade）：先用一种推荐技术产生一种粗糙的推荐结果，第二种推荐技术在此推荐结果的基础上进一步作出更精确的推荐。 6）特征扩充（Feature augmentation）：一种技术产生附加的特征信息嵌入到另一种推荐技术的特征输入中。 7）元级别（Meta-level）：用一种推荐方法产生的模型作为另一种推荐方法的输入。</p>
<h5 id="矩阵分解在推荐系统的应用">矩阵分解在推荐系统的应用</h5>
<p>在推荐系统中，我们常常遇到的问题是这样的，我们有很多用户和物品，也有少部分用户对少部分物品的评分，我们希望预测目标用户对其他未评分物品的评分，进而将评分高的物品推荐给目标用户。比如下面的用户物品评分表：</p>
<center>
<img src="../img/14.jpg">
</center>
<p>协同过滤算法的思想是找用户相似的或者item相似的来做推荐，而矩阵分解的思想是通过一种方法计算出未知的评分，推荐系统基于这样一个假设：用户对项目的打分越高，表明用户越喜欢。因此，预测出用户对未评分项目的评分后，根据分值大小排序，把分值高的项目推荐给用户。</p>
<p>任何矩阵都可以进行奇异值分解，即对于一个<span class="math inline">\(m*n\)</span>矩阵，都有</p>
<p><span class="math display">\[M_{m \times n}=U_{m \times k}\Sigma_{k \times k}V_{k \times n}^T \tag{1}\]</span></p>
<p>这样我们来求第i个用户对第j个物品的评分<span class="math inline">\(m_{ij}\)</span>，只需要计算<span class="math inline">\(u_i^T\Sigma v_j\)</span>，就可以得到得分。这里的前提是已经对矩阵做了分解，而奇异值分解要求矩阵不能有缺省值，因此最初始的解决方法是对缺失值填一个<span class="math inline">\(0\)</span>或者一个全局平均值。实际在推荐系统中用到的矩阵分解是一个伪奇异值分解，它假设对矩阵<span class="math inline">\(M\)</span>分解为两个矩阵乘积，即</p>
<p><span class="math display">\[M_{m \times n}=P_{m \times k}^TQ_{k \times n} \tag{2}\]</span></p>
<p>两个矩阵分别叫用户到隐因子的对应矩阵<span class="math inline">\(P\)</span>，和item到隐因子的对应矩阵<span class="math inline">\(Q\)</span>。例如假设有<span class="math inline">\(k\)</span>个隐因子，用户到隐因子的对应矩阵<span class="math inline">\(P\)</span>的每一行表示用户对每个隐因子的喜好程度，item到隐因子的对应矩阵<span class="math inline">\(Q\)</span>表示当前item属于这个隐因子的比重，则用户对一个item的评分可以用两个矩阵行列的点积来求得，其实在推荐系统中的矩阵分解就是隐因子模型</p>
<p>怎么求解这两个矩阵？采用均方差作为损失函数，对于任意一个评分<span class="math inline">\(\hat{m}_{ij}\)</span>，有<span class="math inline">\(\hat{m}_{ij}=q_j^Tp_i\)</span>，因此均方误差的定义为</p>
<p><span class="math display">\[L=\sum\limits_{i,j}(m_{ij}-q_j^Tp_i)^2 \tag{3}\]</span></p>
<p>最小化均方误差，就可以求出两个矩阵，这样就可以矩阵的缺省值进行预测，这就是BASIC SVD算法</p>
<p>为了防止过拟合，加入<span class="math inline">\(L2\)</span>正则，即损失函数定义为</p>
<p><span class="math display">\[L=\underbrace{arg\;min}_{p_i,q_j}\;\sum\limits_{i,j}(m_{ij}-q_j^Tp_i)^2 + \lambda(||p_i||_2^2 + ||q_j||_2^2 ) \tag{4}\]</span></p>
<p>通过梯度下降法来求，迭代公式为：</p>
<p><span class="math display">\[\frac{\partial J}{\partial p_i} = -2(m_{ij}-q_j^Tp_i)q_j + 2\lambda p_i \tag{5}\]</span> <span class="math display">\[\frac{\partial J}{\partial q_j} = -2(m_{ij}-q_j^Tp_i)p_i + 2\lambda q_j \tag{6}\]</span> <span class="math display">\[p_i = p_i + \alpha((m_{ij}-q_j^Tp_i)q_j - \lambda p_i) \tag{7}\]</span> <span class="math display">\[q_j =q_j +  \alpha((m_{ij}-q_j^Tp_i)p_i - \lambda q_j) \tag{8}\]</span></p>
<p>加入正则化的模型叫RSVD</p>
<p>每个用户对item的评分取决于用户评分的习惯和item的质量，例如一个用户就是喜欢对item打高分，同时item的质量不一样，item质量高的就能得到用户的高的评分，因此加入用户的偏置和物品的偏置，即定义</p>
<p><span class="math display">\[\hat{m}_{ij}=\mu+b_u+b_i+q_j^Tp_i \tag{9}\]</span></p>
<p>其中，<span class="math inline">\(\mu\)</span>是全局平均分，在不同网站中，因为网站定位和销售的物品不同，网站的整体评分分布也会显示出一些差异。比如有些网站中的用户就是喜欢打高分，而另一些网站的用户就是喜欢打低分。而全局平均数可以表示网站本身对用户评分的影响。<span class="math inline">\(b_u\)</span>是用户<span class="math inline">\(u\)</span>的偏置项，这一项表示了用户的评分习惯中和物品没有关系的那种因素。比如有些用户就是比较苛刻，对什么东西要求都很高，那么他的评分就会偏低，而有些用户比较宽容，对什么东西都觉得不错，那么他的评分就会偏高。<span class="math inline">\(b_i\)</span>是item的偏置项，这一项表示了物品接受的评分中和用户没有什么关系的因素。比如有些物品本身质量就很高，因此获得的评分相对都比较高，而有些物品本身质量很差，因此获得的评分相对都会比较低。同样对偏置加上<span class="math inline">\(L2\)</span>正则，则加入偏置后，损失函数变为：</p>
<p><span class="math display">\[L=\underbrace{arg\;min}_{p_i,q_j}\;\sum\limits_{i,j}(m_{ij}-\mu-b_i-b_j-q_j^Tp_i)^2 + \lambda(||p_i||_2^2 + ||q_j||_2^2 + ||b_i||_2^2 + ||b_j||_2^2) \tag{10}\]</span></p>
<p><span class="math inline">\(p_i,q_j\)</span>的迭代公式不变，而<span class="math inline">\(b_u,b_j\)</span>的迭代公式为</p>
<p><span class="math display">\[b_i = b_i + \alpha(m_{ij}-\mu-b_i-b_j-q_j^Tp_i -\lambda b_i) \tag{11}\]</span> <span class="math display">\[b_j = b_j + \alpha(m_{ij}-\mu-b_i-b_j-q_j^Tp_i -\lambda b_j) \tag{12}\]</span></p>
<p>加入偏置的模型叫BSVD</p>
<p>矩阵分解将矩阵分解为两个隐因子矩阵，很好的考虑了用户整体的关系，而没有考虑用户邻域之间的关系，而item-base协同过滤很好的考虑了用户的邻域关系，因此可以将两个模型融合。</p>
<p>融合后的模型的损失函数定义为 <span class="math display">\[\underbrace{arg\;min}_{p_i,q_j}\;\sum\limits_{i,j}(m_{ij}-\mu-b_i-b_j-q_j^Tp_i - q_j^T|N(i)|^{-1/2}\sum\limits_{s \in N(i)}y_{s})^2+ \\ 
\lambda(||p_i||_2^2 + ||q_j||_2^2 + ||b_i||_2^2 + ||b_j||_2^2 + \sum\limits_{s \in N(i)}||y_{s}||_2^2)\]</span></p>
<p>这个模型称为SVD++</p>
<h5 id="参考文献">参考文献</h5>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/06/matrix decomposition/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/06/matrix decomposition/" itemprop="url">
                  矩阵分解及其应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T22:23:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数学/" itemprop="url" rel="index">
                    <span itemprop="name">数学</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/06/matrix decomposition/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/06/matrix decomposition/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="预备">预备</h2>
<blockquote>
<ul>
<li>定义1，给定一个由<span class="math inline">\(n\)</span>维向量集合组成的集合<span class="math inline">\(V\)</span>，如果集合<span class="math inline">\(V\)</span>非空并且对于任意集合<span class="math inline">\(V\)</span>中的向量，满足如下两个条件<br>
</li>
</ul>
<ol style="list-style-type: decimal">
<li>若<span class="math inline">\(a\in V,b\in V\)</span> ,则<span class="math inline">\(a+b\in V\)</span>；<br>
</li>
<li>若<span class="math inline">\(a\in V,\lambda \in R\)</span>，则<span class="math inline">\(\lambda a \in V\)</span>；<br>
则称集合<span class="math inline">\(V\)</span>为向量空间</li>
</ol>
</blockquote>
<p>定义1说明在向量空间中，对向量加和运算和向量数乘运算封闭</p>
<blockquote>
<ul>
<li>定义2，设<span class="math inline">\(V\)</span>为向量空间，如果<span class="math inline">\(r\)</span>个向量<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n} \in V\)</span>，并且满足<br>
1)<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n}\)</span>线性无关；<br>
2)<span class="math inline">\(V\)</span>中任一向量都可由<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n}\)</span>线性标示；<br>
则称向量组<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n}\)</span>为向量空间<span class="math inline">\(V\)</span>的一个基，<span class="math inline">\(n\)</span>称为向量空间<span class="math inline">\(V\)</span>的维数</li>
</ul>
</blockquote>
<p>给定向量空间<span class="math inline">\(V\)</span>下的一个向量<span class="math inline">\(x\)</span>，如果存在<br>
<span class="math display">\[x=\lambda_{1}a_{1}+\lambda_{2}a_{2}+\cdots+\lambda_{n}a_{n} \tag{1}\]</span></p>
<p>则称数组<span class="math inline">\(\lambda_{1},\lambda_{2},\cdots,\lambda_{n}\)</span>为向量<span class="math inline">\(x\)</span>在基<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n}\)</span>下的坐标，向量<span class="math inline">\(x\)</span>在基<span class="math inline">\(a_{1},a_{2}，\cdots，a_{n}\)</span>下可以表示为<br>
<span class="math display">\[x=[\lambda_{1}, \lambda_{2},\cdots,\lambda_{n}] \tag{2}\]</span></p>
<blockquote>
<ul>
<li>定义3，自然基，在<span class="math inline">\(n\)</span>维向量空间中取单位坐标向量组<span class="math inline">\(e_{1},e_{2},\cdots e_{n}\)</span>作为基，向量空间中的任一向量可以表示为<span class="math inline">\(x=x_{1}e_{1} + x_{2}e_{2}+ \cdots + x_{n}e_{n}\)</span>,称<span class="math inline">\(e_{1},e_{2},\cdots e_{n}\)</span>为自然基，向量<span class="math inline">\(x=[x_{1},x_{2},\cdots,x_{n}]\)</span></li>
</ul>
</blockquote>
<p>在定义3中的自然基，任何两个基向量的内积为0，称基向量之间正交，每个基的模为1，称为单位向量。对一个基，如果任意一个向量为单位向量且任意两个向量正交，则称为规范正交基。</p>
<blockquote>
<ul>
<li>定义4，正交矩阵，如果一个<span class="math inline">\(n\)</span>阶方阵满足<span class="math inline">\(A^TA=E(即A^{-1}=A^T)\)</span>，则称方阵<span class="math inline">\(A\)</span>为正交矩阵</li>
</ul>
</blockquote>
<p>从正交矩阵的定义，可以导出正交矩阵行矩阵或列矩阵两两正交且模为1，假设<span class="math inline">\(A\)</span>列矩阵为<br>
<span class="math display">\[A^{T}A=\begin{bmatrix}
x_{1}^{T}\\ 
x_{2}^{T}\\ 
\vdots\\ 
x_{n}^{T}
\end{bmatrix}
\begin{bmatrix}
x_{1} &amp;x_{2}  &amp; \cdots  &amp; x_{n} 
\end{bmatrix}
=
\begin{bmatrix}
1 &amp; 0 &amp;  0&amp; 0\\ 
0 &amp; 1 &amp;  0&amp; 0\\ 
\vdots &amp;  \vdots&amp; \vdots &amp; \vdots\\ 
 0&amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
\Longrightarrow
x_{i}^{T}x_{j}=\delta_{ij}
=
\left\{\begin{matrix}
1,如果i=j\\ 
0,否则i\ne j
\end{matrix}\right. \tag{3}
\]</span></p>
<blockquote>
<ul>
<li>定义5，称变换<span class="math inline">\(T\)</span>是线性的，如果<br>
1、对于<span class="math inline">\(T\)</span>定义域内的一切<span class="math inline">\(u,v\)</span>，<span class="math inline">\(T(u+v)=T(u)+T(v)\)</span><br>
2、对一切<span class="math inline">\(u\)</span>和标量c，<span class="math inline">\(T(cu)=cT(u)\)</span><br>
</li>
<li>定义6，矩阵变换，称一个矩阵乘以一个向量为一个矩阵变换，记作<span class="math inline">\(x\to Ax\)</span></li>
</ul>
</blockquote>
<p>一个变换就是一个映射，由定义可以看出，矩阵变换<span class="math inline">\(x\to Ax\)</span>是一个线性变换</p>
<h2 id="矩阵的几何意义">矩阵的几何意义</h2>
<p>我们知道对于一个向量，给定一组基下就会有一个坐标唯一描述这个向量，假如有两个基描述这个向量，这两个基有什么关系呢？假设向量空间<span class="math inline">\(V\)</span>有两组基<span class="math inline">\(a_{1},a_{2},\cdots,a_{n}和b_{1},b_{2},\cdots,b_{n}\)</span>，则基<span class="math inline">\(b\)</span>可以由<span class="math inline">\(a\)</span>来表示，即有 <span class="math display">\[\left\{\begin{matrix}
b_{1}=p_{11}a_{1}+p_{21}a_{2}+\cdots +p_{n1}a_{n}\\ 
b_{2}=p_{12}a_{1}+p_{22}a_{2}+\cdots +p_{n2}a_{n}\\ 
\cdots \\ 
b_{n}=p_{1n}a_{1}+p_{2n}a_{2}+\cdots +p_{nn}a_{n}
\end{matrix}\right. \tag{4}\]</span></p>
<p>写成矩阵形式，则有 <span class="math display">\[\begin{bmatrix}
b_{1}\\ 
b_{2}\\ 
\vdots\\ 
b_{n}
\end{bmatrix}
=
\begin{bmatrix}
p_{11} &amp; p_{21} &amp; \cdots &amp; p_{n1}\\ 
p_{12} &amp; p_{22} &amp; \cdots &amp; p_{n2}\\ 
\vdots &amp; \vdots &amp; \vdots &amp; \vdots\\ 
p_{1n} &amp; p_{n2} &amp; \cdots &amp; p_{nn}
\end{bmatrix}
\begin{bmatrix}
a_{1}\\ 
a_{2}\\ 
\vdots\\ 
a_{n}
\end{bmatrix}
=P^{T}
\begin{bmatrix}
a_{1}\\ 
a_{2}\\ 
\vdots\\ 
a_{n}
\end{bmatrix} \tag{5}
\]</span></p>
<p>称矩阵<span class="math inline">\(P\)</span>为从基<span class="math inline">\(a\)</span>到基<span class="math inline">\(b\)</span>的过渡矩阵,因为基是线性无关的，因此矩阵<span class="math inline">\(P\)</span>是可逆的，也就是说，两个基之间可以通过一个矩阵来转换。</p>
<blockquote>
<ul>
<li>定理1，设<span class="math inline">\(V_{n}\)</span>中的一个向量<span class="math inline">\(r\)</span>,在基<span class="math inline">\(a_{1},a_{2},\cdots,a_{n}\)</span>下的坐标为<span class="math inline">\([ x_{1},x_{2},\cdots,x_{n}]\)</span>，在基<span class="math inline">\(b_{1},b_{2},\cdots,b_{n}\)</span>下的坐标为<span class="math inline">\([x_{1}&#39;,x_{2}&#39;,\cdots,x_{n}&#39;]\)</span>，矩阵<span class="math inline">\(P\)</span>为从基<span class="math inline">\(a\)</span>到基<span class="math inline">\(b\)</span>的过渡矩阵，则有坐标变换公式 <span class="math display">\[\begin{bmatrix}
x_{1}\\ 
x_{2}\\ 
\vdots\\ 
x_{n}
\end{bmatrix}
=
P
\begin{bmatrix}
x_{1}&#39;\\ 
x_{2}&#39;\\ 
\vdots\\ 
x_{n}&#39;
\end{bmatrix} \tag{6}\]</span></li>
</ul>
</blockquote>
<p>来看一个特殊的情况，假设基向量<span class="math inline">\(a\)</span>为自然基，则有</p>
<p><span class="math display">\[\begin{bmatrix}
b_{1}\\ 
b_{2}\\ 
\vdots\\ 
b_{n}
\end{bmatrix}
=
\begin{bmatrix}
p_{11} &amp; p_{21} &amp; \cdots &amp; p_{n1}\\ 
p_{12} &amp; p_{22} &amp; \cdots &amp; p_{n2}\\ 
\vdots &amp; \vdots &amp; \vdots &amp; \vdots\\ 
p_{1n} &amp; p_{n2} &amp; \cdots &amp; p_{nn}
\end{bmatrix}
\begin{bmatrix}
a_{1}\\ 
a_{2}\\ 
\vdots\\ 
a_{n}
\end{bmatrix}
=P^{T} \tag{7}
\]</span></p>
<p>因此，一个向量在标准坐标系下坐标为<span class="math inline">\(x=[x_{1},x_{2},\cdots,x_{n}]\)</span>,在基<span class="math inline">\(b\)</span>下的坐标为<span class="math inline">\(x&#39;=x^{T}[b_{1}^{T},b_{2}^{T},\cdots,b_{n}^{T}]\)</span>,公式也可以写作 <span class="math display">\[EX^{T}=BX&#39;^{T} \tag{8}\]</span> 也就是矩阵乘法<span class="math inline">\(AX=b\)</span>可以认为是在标准坐标系下坐标是<span class="math inline">\(b\)</span>，在<span class="math inline">\(A\)</span>组成的基下的坐标是<span class="math inline">\(x\)</span></p>
<p>给定一个矩阵<span class="math inline">\(A\)</span>,矩阵<span class="math inline">\(Ax\)</span>可以看成一个基变换，如果认为基变换前后是同一个基，则可以认为<span class="math inline">\(Ax\)</span>是对向量进行角度及长度的变换，矩阵可以认为是一个线性变换，也就是变换基坐标和变换向量是相对的</p>
<p>下面用二维图示进行说明，给定一个二维对角矩阵 <span class="math display">\[M=\begin{bmatrix}
3 &amp; 0\\ 
0 &amp; 1
\end{bmatrix} \tag{9}\]</span> 从几何上讲，<span class="math inline">\(M\)</span>是将二维平面上的点<span class="math inline">\((x,y)\)</span>经过线性变换到另外一个点的变换矩阵</p>
<span class="math display">\[M=\begin{bmatrix}
3 &amp; 0\\ 
0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
x\\ 
y
\end{bmatrix}
=
\begin{bmatrix}
3x\\ 
y
\end{bmatrix} \tag{10}
\]</span> 变换的效果如下图所示，变换后的平面仅仅是沿 X 水平方面进行了拉伸3倍，垂直方向是并没有发生变化。
<center>
<img src="/img/1.jpg">
</center>
<p>现在看下矩阵</p>
<span class="math display">\[M=\begin{bmatrix}
2 &amp; 1\\ 
1 &amp; 2
\end{bmatrix}
\begin{bmatrix}
x\\ 
y
\end{bmatrix}
=
\begin{bmatrix}
2x+y\\ 
x+2y
\end{bmatrix} \tag{11}
\]</span> 这个矩阵产生的变换效果如下图所示
<center>
<img src="/img/2.jpg">
</center>
这种变换效果看起来非常的奇怪，在实际环境下很难描述出来变换的规律 ( 这里应该是指无法清晰辨识出旋转的角度，拉伸的倍数之类的信息)。还是基于上面的对称矩阵，假设我们把左边的平面旋转45度角，然后再进行矩阵<span class="math inline">\(M\)</span>的线性变换，效果如下图所示：
<center>
<img src="/img/3.jpg">
</center>
<p>看起来是不是有点熟悉？ 对的，经过 M 线性变换后，跟前面的对角矩阵的功能是相同的，都是将网格沿着一个方向拉伸了3倍。</p>
<p>从上边看出，一个矩阵可以对向量进行旋转和拉伸作用，有没有矩阵对向量仅仅进行旋转变化，不进行拉伸呢？正交变换就仅仅对向量进行旋转，不进行拉伸</p>
<blockquote>
<ul>
<li>定理二，若<span class="math inline">\(P\)</span>为正交矩阵，则线性变换<span class="math inline">\(y=Px\)</span>称为正交变换，并且变换后向量大小不变</li>
</ul>
</blockquote>
<p>向量是否拉伸可以通过向量的2阶范数来反映，即</p>
<p><span class="math display">\[\parallel y \parallel =\sqrt{y^{T}y}=\sqrt{x^{T}P^{T}Px}=\sqrt{x^{T}x}=\parallel x \parallel \tag{12}\]</span></p>
<p>下面以一个图示来演示正交变换,假设二维空间中的一个向量<span class="math inline">\(OA\)</span>，它在标准坐标系也即<span class="math inline">\(e1、e2\)</span>表示的坐标是中表示为<span class="math inline">\((a,b)^{T}\)</span>，现在把它用另一组坐标<span class="math inline">\(e1&#39;、e2&#39;\)</span>表示为<span class="math inline">\((a&#39;,b&#39;)^{T}\)</span>，存在矩阵<span class="math inline">\(U\)</span>使得<span class="math inline">\(U(a&#39;,b&#39;)^{T}=(a,b)^{T}\)</span></p>
<center>
<img src="/img/4.jpg">
</center>
<p>容易求出<span class="math inline">\(U\)</span>，其中<span class="math inline">\(e_{1}&#39;=[\cos\theta,\sin\theta]^{T}，e_{2}&#39;=[-\sin\theta,\cos\theta]\)</span>，因此 <span class="math display">\[U=\begin{bmatrix}
\cos\theta &amp; -\sin\theta\\ 
\sin\theta &amp; \cos\theta 
\end{bmatrix} \tag{13}\]</span></p>
下图展示了基变换和向量方向变换的等价
<center>
<img src="/img/5.jpg">
</center>
<p>有没有矩阵变换，仅仅对向量进行拉伸，不改变方向呢，这就是方阵的特征值和特征向量</p>
<h2 id="方阵的特征值及特征向量">方阵的特征值及特征向量</h2>
<blockquote>
<ul>
<li>定义7，设<span class="math inline">\(A\)</span>是<span class="math inline">\(n\)</span>阶矩阵，如果<span class="math inline">\(\lambda\)</span>和<span class="math inline">\(n\)</span>维非零列向量<span class="math inline">\(x\)</span>满足如下关系 <span class="math display">\[Ax=\lambda x \tag{14}\]</span> 则称<span class="math inline">\(\lambda\)</span>为矩阵<span class="math inline">\(A\)</span>的特征值，向量<span class="math inline">\(x\)</span>为矩阵<span class="math inline">\(A\)</span>的特征向量</li>
</ul>
</blockquote>
<p>从定义看出，矩阵<span class="math inline">\(A\)</span>仅仅对特征向量进行了<span class="math inline">\(\lambda\)</span>的拉伸，假设所有的特征值组成可逆矩阵<span class="math inline">\(Q\)</span>，特征值组成对角矩阵<span class="math inline">\(\Sigma\)</span>，则矩阵<span class="math inline">\(A\)</span>可以分解为 <span class="math display">\[A=Q\Sigma Q^{-1} \tag{15}\]</span> 以上称为矩阵的特征值分解</p>
<blockquote>
<ul>
<li>定义8，矩阵的相似性，设<span class="math inline">\(A,B\)</span>都是<span class="math inline">\(n\)</span>阶矩阵，如果存在可逆矩阵<span class="math inline">\(P\)</span>,使得， <span class="math display">\[P^{-1}AP=B \tag{16}\]</span> 则称<span class="math inline">\(A,B\)</span>相似</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>定理三，如果<span class="math inline">\(n\)</span>阶矩阵<span class="math inline">\(A,B\)</span>相似，则他们有相同的特征多项式，从而有相同的特征值</li>
</ul>
</blockquote>
<p>容易证明</p>
<p><span class="math display">\[\left | B-\lambda E \right | = \left | P^{-1}AP-P^{-1}(\lambda E)P \right | = \left | P^{-1}(A-
\lambda E)P \right | = \left | P^{-1} \right | \left | A-
\lambda E \right | \left | P \right | = \left | A-\lambda E \right | \tag{17}\]</span></p>
<p>因此，如果一个矩阵<span class="math inline">\(A\)</span>跟一个上(下)三角矩阵或者对角阵相似，则对角线的<span class="math inline">\(n\)</span>个值就是<span class="math inline">\(A\)</span>的特征值。同理，对于<span class="math inline">\(n\)</span>阶矩阵<span class="math inline">\(A\)</span>，能否找到一个可逆矩阵<span class="math inline">\(P\)</span>使得<span class="math inline">\(P^{-1}AP=\Lambda\)</span>，其中<span class="math inline">\(\Lambda\)</span>为对角矩阵，如果存在，则称方阵<span class="math inline">\(A\)</span>的对角化分解。</p>
<p>首先来看如果存在可逆矩阵<span class="math inline">\(P\)</span>，它会满足什么条件，根据定义，把可逆矩阵写成列向量，即<span class="math inline">\(P=(p_{1},p_{2},\cdots,p_{n})\)</span> ，根据<span class="math inline">\(P^{-1}AP=\Lambda\)</span> ,有<span class="math inline">\(AP=\Lambda P\)</span>,既有</p>
<p><span class="math display">\[A(p_{1},p_{2},\cdots,p_{n})=(p_{1},p_{2},\cdots,p_{n})\begin{bmatrix}
\lambda_{1} &amp;  &amp;  &amp; \\ 
 &amp; \lambda_{2} &amp;  &amp; \\ 
 &amp;  &amp; \ddots   &amp; \\ 
 &amp;  &amp;  &amp;  \lambda_{n}
\end{bmatrix}
=(\lambda_{1}p_{1},\lambda_{2}p_{2},\cdots,\lambda_{n}p_{n}) \tag{18}\]</span></p>
<p>即，如果矩阵<span class="math inline">\(A\)</span>能对角化，则对角化<span class="math inline">\(\Lambda\)</span>为特征值组成的对角矩阵，可逆矩阵为特征向量组成的矩阵，因此特征值分解可以实现矩阵的对角化分解。</p>
<blockquote>
<ul>
<li>定理四，一个<span class="math inline">\(n\)</span>矩阵能够对角化的充分必要条件是它有<span class="math inline">\(n\)</span>个线性无关的特征向量。特别的，对于对称矩阵<span class="math inline">\(A(即A^{T}=A)\)</span>，它的任意两个不同特征值对应的特征向量正交；并且必有正交阵<span class="math inline">\(P\)</span>，使 <span class="math display">\[P^{-1}AP=P^{T}AP=\Lambda \tag{19}\]</span> <span class="math inline">\(\Lambda\)</span>为特征值组成的对角化矩阵</li>
</ul>
</blockquote>
<h4 id="矩阵相似的意义">矩阵相似的意义</h4>
<p>我们知道矩阵对应一个在给定基下的线性变换，如果同一个线性变换，在基<span class="math inline">\(a\)</span>下的变换矩阵为<span class="math inline">\(A\)</span>，在<span class="math inline">\(b\)</span>下的变换矩阵为B，则<span class="math inline">\(A,B\)</span>有什么关系呢? 根据基变换的性质，基<span class="math inline">\(b\)</span>可以由基<span class="math inline">\(a\)</span>和一个矩阵乘积来表示，即<span class="math inline">\(b=aP\)</span>，则对于线性变换<span class="math inline">\(L\)</span>有</p>
<p><span class="math display">\[\begin{array}{l}
L(b)=L(a)P \\ \Rightarrow
{[ L(b_1) \cdots L(b_n) ] = [ L(a_1) \cdots L(a_n) ]\; P }\\ \Rightarrow
{(b_1\cdots b_n)B=(a_1\cdots a_n)AP}\\ \Rightarrow 
{(a_1\cdots a_n)PB=(a_1\cdots a_n)AP}\\ \Rightarrow {PB=AP}
\\ \Rightarrow {B=P^{-1}AP}
\end{array} \tag{20}\]</span></p>
<p>也就是说，两个矩阵相似，表示这两个矩阵是在不同的基表示下的同一个线性变换，特别，可逆矩阵<span class="math inline">\(P\)</span>为两个基的过渡矩阵</p>
<h4 id="特征值及特征向量的意义">特征值及特征向量的意义</h4>
<p>根据矩阵相似的意义，方阵<span class="math inline">\(A\)</span>的特征值分解可以理解两个不同基下的同一个变换，其中特征向量组成的矩阵是两个变换的过渡矩阵，特别的，假设其中一个基是自然基，则另一个基为<span class="math inline">\(P\)</span>或者<span class="math inline">\(P^{-1}\)</span>，假设对角阵对应的基为自然基，则方阵<span class="math inline">\(A\)</span>对应的基为<span class="math inline">\(P\)</span>，也就是向量<span class="math inline">\(A\)</span>的变换是对自然基组成的向量做特征值大小的缩放。</p>
<p>从线性空间的角度看，在一个定义了内积的线性空间里，对一个<span class="math inline">\(n\)</span>阶对称方阵进行特征分解，就是产生了该空间的<span class="math inline">\(n\)</span>个标准正交基，然后把矩阵投影到这<span class="math inline">\(n\)</span>个基上。<span class="math inline">\(n\)</span>个特征向量就是<span class="math inline">\(n\)</span>个标准正交基，因为对称方阵的特征向量是一个正交矩阵，所以，N个特征向量就是N个标准正交基，而特征值的模则代表矩阵在每个基上的投影长度。而特征值的模则代表矩阵在每个基上的投影长度。特征值越大，说明矩阵在对应的特征向量上的方差越大，功率越大，信息量越多。</p>
<p>对于小方阵，特征值及特征向量可以通过定义来求得。下面来看怎么求特征值及特征向量，由定义式可有 <span class="math display">\[(A-\lambda E)x=0 \tag{21}\]</span> 这是一个<span class="math inline">\(n\)</span>个未知数<span class="math inline">\(n\)</span>个方程的齐次线性方程组，因它有非零解的条件是特征多项式为<span class="math inline">\(0\)</span>，即 <span class="math display">\[\left |A-\lambda E  \right |=0 \tag{22}\]</span></p>
<p>假设<span class="math inline">\(n\)</span>阶方阵<span class="math inline">\(A\)</span>的特征值分别为<span class="math inline">\(\lambda_{1},\lambda_{2},\cdots,\lambda_{n}\)</span>，特征值有如下性质<br>
* 1) <span class="math inline">\(\lambda_{1}+\lambda_{2}+\cdots+\lambda_{n} = a_{11}+a_{22}+\cdots+a_{nn}\)</span><br>
* 2) <span class="math inline">\(\lambda_{1}\lambda_{2}\cdots\lambda_{n}=\left |A\right|\)</span></p>
<p>但对于大型的方阵，可以通过矩阵的QR分解来求。</p>
<h2 id="矩阵的奇异值分解">矩阵的奇异值分解</h2>
<p>根据特征值分解的描述，特征值的大小可以看成矩阵在某一方向的拉伸大小，如果矩阵在某些方向上的拉伸比较小，也就是特征值比较小，如果不考虑这些特征值的影响，矩阵的变换作用影响不大，因此可以用特征值分解来降维。</p>
<p>上面讲的特征值分解是针对方阵的，那么对于普通的矩阵，会有这样的分解吗？其实，对于任何矩阵矩阵<span class="math inline">\(A_{mn}\)</span>，存在一个正交矩阵<span class="math inline">\(U_{mm}\)</span>，一个正交矩阵<span class="math inline">\(V_{nn}\)</span>，一个对角矩阵<span class="math inline">\(\Lambda_{mn}\)</span>，使得</p>
<p><span class="math display">\[A_{mn}=U_{mm}\Lambda_{mn}V^{T}_{nn} \tag{23}\]</span> 成立，这就是矩阵的奇异值分解。</p>
<p>首先对于任何<span class="math inline">\(A_{mn}\)</span>，都有<span class="math inline">\(A^{T}A\)</span>是对称矩阵，根据对称矩阵的特征分解，有 <span class="math display">\[A^{T}A=Q\Sigma Q^{-1} \tag{24}\]</span></p>
<p>假设我们得到一组正交基<span class="math inline">\({v_1,v_2,\cdots,v_n}\)</span>，即<span class="math inline">\(A^{T}Av_i = \lambda_iv_i\)</span>，下面看对正交基进行<span class="math inline">\(A\)</span>线性变换的向量组<span class="math inline">\({Av_1,Av_2,\cdots,Av_n}\)</span></p>
<p><span class="math display">\[(Av_{i},Av_{j})\\
=(Av_{i})^{T}(Av_{j})\\
=v^{T}_{i}A^{T}Av_{j}\\
=v^{T}_{i}(\lambda_{j}v_{j})\\
=\lambda_{j}v^{T}_iv_{j}\\
=0 \tag{25}
\]</span></p>
<p>也就是经过矩阵<span class="math inline">\(A\)</span>线性变换后的基<span class="math inline">\({Av_1,Av_2,\cdots,Av_n}\)</span>也是正交的，将其标准化，即将<span class="math inline">\(Av_{i}\)</span>变换为</p>
<p><span class="math display">\[u_{i}=\frac{Av_{i}}{\left | Av_{i} \right | } = \frac{1}{\sqrt{\lambda_{i}}}Av_{i} \tag{26}\]</span></p>
<p>如果令<span class="math inline">\(\delta_{i} = \sqrt{\lambda_{i}}\)</span>，称<span class="math inline">\(\delta_{i}\)</span>为奇异值，则有<span class="math inline">\(Av_{i} = \sqrt{\lambda_{i}}u_{i}\)</span></p>
<p>假设矩阵<span class="math inline">\(A\)</span>的秩为<span class="math inline">\(rank(A)=r\)</span>，则<span class="math inline">\(rank（A^{T}A）=rank(AA^{T})=rank(A)=r\)</span>，则对称矩阵<span class="math inline">\(A^{T}A\)</span>有<span class="math inline">\(r\)</span>个非零的特征值，因此对于这<span class="math inline">\(r\)</span>个特征值对应的特征向量都有<span class="math inline">\(Av_{i}\ne0\)</span>,而为<span class="math inline">\(0\)</span>的特征值对应的特征向量都有<span class="math inline">\(Av_{i}=0\)</span></p>
<p>因此，由<span class="math inline">\(u_1,u_2,\cdots,u_r\)</span>组成的基是一个正交基，如果<span class="math inline">\(r&lt;m\)</span>，通过正交化将其扩展为<span class="math inline">\(R^{m}\)</span>上的正交基</p>
<p><span class="math display">\[AV=A(v_{1},v_{2},\cdots,v_{n})\\
=(Av_{1},Av_{2},\cdots,Av_{r},0,0,\cdots,0)\\
=(\delta_{1}u_{1},\delta_{2}u_{2},\cdots,\delta_{r}u_{r},0,0,\cdots.0)
=U\Sigma\\
\Longrightarrow A=U\Sigma V_{T} \tag{27}
\]</span></p>
<p><span class="math inline">\(v_{i}\)</span>是对称矩阵<span class="math inline">\(A^{T}A\)</span>的特征向量，称为<span class="math inline">\(A\)</span>的右奇异向量，实际上<span class="math inline">\(u_{i}\)</span>是<span class="math inline">\(AA^{T}\)</span>的特征向量，称为<span class="math inline">\(A\)</span>的左奇异向量。</p>
<p>写成分块形式如下</p>
<p><span class="math display">\[A=\left[
\begin{array}{ccc|ccc}
    u_{1} &amp; \cdots &amp; u_{k} &amp; u_{k+1} &amp; \cdots &amp; u_{m}
\end{array}
\right]
\left[
\begin{array}{ccc|c}
\sigma_{1} &amp;  &amp; &amp;\\
 &amp; \ddots &amp; &amp; 0\\
 &amp;  &amp;  \sigma_{k} &amp; \\ \hline
 &amp;   &amp; &amp;   \\
 &amp; 0 &amp; &amp; 0 \\
 &amp;   &amp; &amp;   \\
\end{array}
\right]
\begin{bmatrix}
v^{T}_{1} \\ 
\vdots \\ 
v^{T}_{k}\\ \hline
v^{T}_{k+1}\\
\vdots \\
v^{T}_{n}
\end{bmatrix}\\
\Longrightarrow
A=
\begin{bmatrix}
u_{1} &amp; \cdots &amp; u_{k}  
\end{bmatrix}
\begin{bmatrix}
\sigma_{1} &amp; &amp; \\
&amp; \ddots &amp; \\
&amp; &amp; \sigma_{k}  
\end{bmatrix}
\begin{bmatrix}
v^{T}_{1}\\
\vdots\\
v^{T}_{k}   
\end{bmatrix}
+
\begin{bmatrix}
u_{k+1} &amp; \cdots &amp; u_{m}  
\end{bmatrix}
\begin{bmatrix}
&amp; &amp; \\
&amp; 0 &amp; \\
&amp; &amp; \\  
\end{bmatrix}
\begin{bmatrix}
v^{T}_{k+1}\\
\vdots\\
v^{T}_{n}   
\end{bmatrix}\\
\Longrightarrow
A=
\begin{bmatrix}
u_{1} &amp; \cdots &amp; u_{k}  
\end{bmatrix}
\begin{bmatrix}
\sigma_{1} &amp; &amp; \\
&amp; \ddots &amp; \\
&amp; &amp; \sigma_{k}  
\end{bmatrix}
\begin{bmatrix}
v^{T}_{1}\\
\vdots\\
v^{T}_{k}   
\end{bmatrix} \tag{28}
\]</span></p>
<p>奇异值的意义跟特征值的意义相似，正交基<span class="math inline">\(U_{mm}\)</span>表示原空间的正交基，正交基<span class="math inline">\(V_{nn}\)</span>表示目标空间的正交基，而对角矩阵<span class="math inline">\(\Lambda\)</span>表示变换的重要性</p>
<h2 id="奇异值的应用">奇异值的应用</h2>
<h4 id="数据压缩">数据压缩</h4>
<p>从分解公式看出，如果矩阵的秩<span class="math inline">\(r\)</span>远小于<span class="math inline">\(m,n\)</span>，则矩阵可以压缩标示而且又不失真，特别的如果忽略小的奇异值，还能对数据进行压缩，比如一张图像就是一个大的二维矩阵，如果是彩色的就是三个大矩阵，比如一幅<span class="math inline">\(1000*1000\)</span>的图像<span class="math inline">\(A\)</span>，存储就需要<span class="math inline">\(1000000\)</span>个像素了，如果矩阵的秩是<span class="math inline">\(r\)</span>，则总共需要存储的数据是<span class="math inline">\(1000*r+r*r+1000+r\)</span>,如果考虑<span class="math inline">\(k\)</span>大的特征值，只需要<span class="math inline">\(1000*k+k*k+1000+k\)</span></p>
下面给出一个图像进行svd分解后选取不同的特征值进行图像还原的效果
<center>
<img src="/img/lena.jpg"> <img src="/img/6.jpg"> <img src="/img/pic.jpg"> <img src="/img/7.jpg">
</center>
<h4 id="求解pca">求解PCA</h4>
<h4 id="隐语义分析latent-semantic-analysis">隐语义分析(Latent Semantic Analysis)</h4>
在文本处理中，潜在语义分析（LSA）假设在词项和文档之间有一个潜在语义层，词汇和语义产生关联，文档也和语义产生关联。这样通过语义概念，可以将词项和文档放在一个语义空间中观察分析。比如文档分类问题，隐含的主题可以理解为文档属于什么主题的文档(体育，娱乐，科技等)，LSA使用SVD分解来求解，下面以一个例子来说明，假设有3个文档
<center>
<img src="/img/8.jpg">
</center>
查询词：gold silver truck 首先把文档分词组织成一个二维矩阵，查询词组织成一个向量，如下
<center>
<img src="/img/9.jpg">
</center>
对矩阵<span class="math inline">\(A\)</span>进行SVD分解，结果如下
<center>
<img src="/img/10.jpg">
</center>
只保留2个奇异值，则变为
<center>
<img src="/img/11.jpg">
</center>
这样可以求得三个文档在语义空间上的映射为
<center>
d1(-0.4945, 0.6492)<br>
d2(-0.6458, -0.7194)<br>
d3(-0.5817, 0.2469)
</center>
<p>将查询词映射到语义空间</p>
<center>
<img src="/img/12.jpg">
</center>
这样就可以用相似性来度量查询词跟文档的相关性了
<center>
<img src="/img/13.jpg">
</center>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/13/curl-linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jingchen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎光临我的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/13/curl-linux/" itemprop="url">
                  Linux下curl的用法及shell处理json数据介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-13T14:03:01+08:00">
                2017-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/13/curl-linux/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/13/curl-linux/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="请求的url为什么要进行编码">请求的url为什么要进行编码</h2>
<p>url(Uniform Resource Locator)统一资源定位符，即我们通常说的网址，完整的URL由这几个部分构成：</p>
<center>
scheme://host:port/path?query#fragment
</center>
<p>其中，</p>
<p>scheme:通信协议，常用的http,ftp,maito,https等；</p>
<p>host:主机，服务器(计算机)域名系统 (DNS) 主机名或 IP 地址；</p>
<p>port:端口号，整数，可选，省略时使用方案的默认端口，如http的默认端口为80,https的默认端口是443；</p>
<p>path:路径，由零或多个“/”符号隔开的字符串，一般用来表示主机上的一个目录或文件地址；</p>
<p>query:查询，可选，用于给动态网页（如使用CGI、ISAPI、PHP/JSP/ASP/ASP.NET等技术制作的网页）传递参数，可有多个参数，用“&amp;”符号隔开，每个参数的名和值用“=”符号隔开；</p>
<p>fragment:信息片断，字符串，用于指定网络资源中的片断。例如一个网页中有多个名词解释，可使用fragment直接定位到某一名词解释。(也称为锚点.)这个标志点不是统一资源标志符的一部分，而是让用户浏览器在获得了文件后来导航用的，因此它实际上不被送到服务器。</p>
<p>网络标准<a href="http://www.ietf.org/rfc/rfc1738.txt" target="_blank" rel="external">RFC 1738</a>对url的编码进行的规定 &gt;只有字母和数字[0-9a-zA-Z]、一些特殊符号“$-_.+!*’(),“[不包括双引号]、以及某些保留字，才可以不经过编码直接用于URL</p>
<p>除了上边的这些字符，在url中出现时，都要经过编码,RFC 1738没有规定具体的编码方法，而是交给应用程序（浏览器）自己决定，具体的编码方式可以查看这篇<a href="http://www.ruanyifeng.com/blog/2010/02/url_encoding.html" target="_blank" rel="external">文章</a>和<a href="https://www.zhihu.com/question/19673368" target="_blank" rel="external">这篇</a>，例如双引号可以用，汉字可以用其他编码方式来表示</p>
<p>shell下有个挺好用的工具curl，可以进行服务器之间的通信，但是如果请求的参数中有{}或者[]，例如请求参数是json格式，如http://abc.com/query?a=b&amp;c=d&amp;{&quot;name&quot;:&quot;1&quot;,&quot;age&quot;:3}，否则curl会进行多次的请求，因为在curl中，可以用{}来指定多个url，如http://site.{one,two,three}.com，这将请求三次，分别为one,two,three,用[]可以用来指定一个范围，如ftp://ftp.numericals.com/file[1-100].txt</p>
<h2 id="curl详细介绍">curl详细介绍</h2>
<p>curl是一个向服务器或者从服务器下载数据的传输工具，它支持HTTP, HTTPS, FTP, FTPS, SCP, SFTP, TFTP, DICT, TELNET, LDAP or FILE等协议，这个命令设计为不需要用户的干预来执行。curl提供了非常多有用的功能，比如代理支持，用户认证，HTTP POST ,FTP Upload,断点续传等等,curl所有传输相关功能都基于libcurl。</p>
<p>详细用法</p>
<blockquote>
<ul>
<li><strong>直接请求，返回源代码</strong><br>
curl http://wwww.baidu.com</li>
<li><strong>保存网页内容</strong>，-o：将文件保存为命令行中指定的文件名的文件中,-O：使用URL中默认的文件名保存文件到本地<br>
curl -o [文件名] www.sina.com</li>
<li><strong>自动跳转,有的网址是自动跳转的</strong>。使用<code>-L</code>参数，curl就会跳转到新的网址。<br>
curl -L www.sina.com</li>
<li><strong>显示头信息</strong> <code>-i</code>参数可以显示http response的头信息，连同网页代码一起。<code>-I</code>参数则是只显示http response的头信息。 curl -i www.sina.com</li>
<li><strong>显示通信过程</strong>, <code>-v</code>参数可以显示一次http通信的整个过程，包括端口连接和http request头信息。–trace可以显示更详细内容<br>
curl -v www.sina.com<br>
curl –trace output.txt www.sina.com<br>
curl –trace-ascii output.txt www.sina.com</li>
<li><strong>发送表单信息</strong>,发送表单信息有GET和POST两种方法。GET方法相对简单，只要把数据附在网址后面就行。<br>
curl example.com/form.cgi?data=xxx<br>
POST方法必须把数据和网址分开，curl就要用到–data参数.<br>
curl -X POST –data “data=xxx” example.com/form.cgi<br>
如果你的数据没有经过表单编码，还可以让curl为你编码，参数是<code>--data-urlencode</code>。<br>
curl -X POST–data-urlencode “date=April 1” example.com/form.cgi<br>
</li>
<li><strong>HTTP动词</strong> curl默认的HTTP动词是GET，使用<code>-X</code>参数可以支持其他动词。 curl -X POST www.example.com curl -X DELETE www.example.com</li>
<li><strong>文件上传</strong> 假定文件上传的表单是下面这样：</li>
</ul>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">'multipart/form-data'</span> <span class="attr">action</span>=<span class="string">"upload.cgi"</span>&gt;</span></div><div class="line">　　　　	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">file</span> <span class="attr">name</span>=<span class="string">upload</span>&gt;</span></div><div class="line">　　　　	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">name</span>=<span class="string">press</span> <span class="attr">value</span>=<span class="string">"OK"</span>&gt;</span></div><div class="line">　　    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>则上传命令是curl –form upload=<span class="citation">@localfilename</span> –form press=OK [URL]<br>
</li>
<li><strong>cookie</strong> 使用<code>--cookie</code>参数，可以让curl发送cookie。<br>
curl –cookie “name=xxx” www.example.com<br>
</li>
<li><strong>增加头信息</strong> 有时需要在http request之中，自行增加一个头信息。<code>--header</code>参数就可以起到这个作用<br>
curl –header “Content-Type:application/json” http://example.com<br>
</li>
<li><strong>HTTP认证</strong> 有些网域需要HTTP认证，这时curl需要用到<code>--user</code>参数。<br>
curl –user name:password example.com</li>
<li><strong>断点续传</strong> 通过使用-C选项可对大文件使用断点续传功能<br>
#当文件在下载完成之前结束该进程<br>
$ curl -O http://www.gnu.org/software/gettext/manual/gettext.html<br>
############## 20.1%<br>
# 通过添加-C选项继续对该文件进行下载，已经下载过的文件不会被重新下载<br>
curl -C - -O http://www.gnu.org/software/gettext/manual/gettext.html<br>
############### 21.1%<br>
</li>
<li><strong>网络限速</strong> ,通过–limit-rate选项对CURL的最大网络使用进行限制<br>
curl –limit-rate 1000B -O http://www.gnu.org/software/gettext/manual/gettext.html</li>
</ul>
</blockquote>
<h2 id="shell处理json">shell处理json</h2>
<p>通常大部分接口都是json格式的，对于大部分程序语言，都有库或者函数来实现json的序列化和反序列化，shell中也有命令可以处理json数据，如<a href="https://stedolan.github.io/jq/tutorial/" target="_blank" rel="external">jq</a>命令，需要手动安装<br>
&gt; * 下载<a href="https://github.com/stedolan/jq/releases/download/jq-1.5/jq-1.5.tar.gz" target="_blank" rel="external">源码</a>，执行./configure &amp;&amp; make &amp;&amp; sudo make install</p>
<p>测试 &gt; * 获取数据<br>
curl ‘https://api.github.com/repos/stedolan/jq/commits?per_page=5’ &gt; json.data<br>
结果如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    "sha": "d25341478381063d1c76e81b3a52e0592a7c997f",</div><div class="line">    "commit": &#123;</div><div class="line">      "author": &#123;</div><div class="line">        "name": "Stephen Dolan",</div><div class="line">        "email": "mu@netsoc.tcd.ie",</div><div class="line">        "date": "2013-06-22T16:30:59Z"</div><div class="line">      &#125;,</div><div class="line">      "committer": &#123;</div><div class="line">        "name": "Stephen Dolan",</div><div class="line">        "email": "mu@netsoc.tcd.ie",</div><div class="line">        "date": "2013-06-22T16:30:59Z"</div><div class="line">      &#125;,</div><div class="line">      "message": "Merge pull request #162 from stedolan/utf8-fixes\n\nUtf8 fixes. Closes #161",</div><div class="line">      "tree": &#123;</div><div class="line">        "sha": "6ab697a8dfb5a96e124666bf6d6213822599fb40",</div><div class="line">        "url": "https://api.github.com/repos/stedolan/jq/git/trees/6ab697a8dfb5a96e124666bf6d6213822599fb40"</div><div class="line">      &#125;,</div><div class="line">      "url": "https://api.github.com/repos/stedolan/jq/git/commits/d25341478381063d1c76e81b3a52e0592a7c997f",</div><div class="line">      "comment_count": 0</div><div class="line">    &#125;,</div><div class="line">    "url": "https://api.github.com/repos/stedolan/jq/commits/d25341478381063d1c76e81b3a52e0592a7c997f",</div><div class="line">    "html_url": "https://github.com/stedolan/jq/commit/d25341478381063d1c76e81b3a52e0592a7c997f",</div><div class="line">    "comments_url": "https://api.github.com/repos/stedolan/jq/commits/d25341478381063d1c76e81b3a52e0592a7c997f/comments",</div><div class="line">    "author": &#123;</div><div class="line">      "login": "stedolan",</div><div class="line">	...</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>高亮显示 用jq “.” json.data</li>
<li>获取数据某一项 jq “.[n]” json.data ,如 jq “.[1]” json.data <figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">	&#123;</div><div class="line">  <span class="attr">"sha"</span>: <span class="string">"125071cf005e687d4beba9d5822b1c6a72d7d14c"</span>,</div><div class="line">  <span class="attr">"commit"</span>: &#123;</div><div class="line">    <span class="attr">"author"</span>: &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span>,</div><div class="line">      <span class="attr">"email"</span>: <span class="string">"nico@cryptonector.com"</span>,</div><div class="line">      <span class="attr">"date"</span>: <span class="string">"2017-02-04T06:11:10Z"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"committer"</span>: &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span>,</div><div class="line">      <span class="attr">"email"</span>: <span class="string">"nico@cryptonector.com"</span>,</div><div class="line">      <span class="attr">"date"</span>: <span class="string">"2017-02-04T06:11:10Z"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Fix handling of unsupported math functions"</span>,</div><div class="line">    <span class="attr">"tree"</span>: &#123;</div><div class="line">      <span class="attr">"sha"</span>: <span class="string">"98bbc0beba737efc16c7d345b3c06c88302f5912"</span>,</div><div class="line">      <span class="attr">"url"</span>: <span class="string">"https://api.github.com/repos/stedolan/jq/git/trees/98bbc0beba737efc16c7d345b3c06c88302f5912"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"url"</span>: <span class="string">"https://api.github.com/repos/stedolan/jq/git/commits/125071cf005e687d4beba9d5822b1c6a72d7d14c"</span>,</div><div class="line">    <span class="attr">"comment_count"</span>: <span class="number">0</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"url"</span>: <span class="string">"https://api.github.com/repos/stedolan/jq/commits/125071cf005e687d4beba9d5822b1c6a72d7d14c"</span>,</div><div class="line">  <span class="attr">"html_url"</span>: <span class="string">"https://github.com/stedolan/jq/commit/125071cf005e687d4beba9d5822b1c6a72d7d14c"</span>,</div><div class="line">  <span class="attr">"comments_url"</span>: <span class="string">"https://api.github.com/repos/stedolan/jq/commits/125071cf005e687d4beba9d5822b1c6a72d7d14c/comments"</span>,</div><div class="line">  <span class="attr">"author"</span>: &#123;</div><div class="line">    <span class="attr">"login"</span>: <span class="string">"nicowilliams"</span>,</div><div class="line">    <span class="attr">"id"</span>: <span class="number">604851</span>,</div><div class="line">    <span class="attr">"avatar_url"</span>: <span class="string">"https://avatars.githubusercontent.com/u/604851?v=3"</span>,</div><div class="line">    <span class="attr">"gravatar_id"</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">"url"</span>: <span class="string">"https://api.github.com/users/nicowilliams"</span>,</div><div class="line">    <span class="attr">"html_url"</span>: <span class="string">"https://github.com/nicowilliams"</span>,</div><div class="line">    <span class="attr">"followers_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/followers"</span>,</div><div class="line">    <span class="attr">"following_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/following&#123;/other_user&#125;"</span>,</div><div class="line">    <span class="attr">"gists_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/gists&#123;/gist_id&#125;"</span>,</div><div class="line">    <span class="attr">"starred_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/starred&#123;/owner&#125;&#123;/repo&#125;"</span>,</div><div class="line">    <span class="attr">"subscriptions_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/subscriptions"</span>,</div><div class="line">    <span class="attr">"organizations_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/orgs"</span>,</div><div class="line">    <span class="attr">"repos_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/repos"</span>,</div><div class="line">    <span class="attr">"events_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/events&#123;/privacy&#125;"</span>,</div><div class="line">    <span class="attr">"received_events_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/received_events"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"User"</span>,</div><div class="line">    <span class="attr">"site_admin"</span>: <span class="literal">false</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"committer"</span>: &#123;</div><div class="line">    <span class="attr">"login"</span>: <span class="string">"nicowilliams"</span>,</div><div class="line">    <span class="attr">"id"</span>: <span class="number">604851</span>,</div><div class="line">    <span class="attr">"avatar_url"</span>: <span class="string">"https://avatars.githubusercontent.com/u/604851?v=3"</span>,</div><div class="line">    <span class="attr">"gravatar_id"</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">"url"</span>: <span class="string">"https://api.github.com/users/nicowilliams"</span>,</div><div class="line">    <span class="attr">"html_url"</span>: <span class="string">"https://github.com/nicowilliams"</span>,</div><div class="line">    <span class="attr">"followers_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/followers"</span>,</div><div class="line">    <span class="attr">"following_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/following&#123;/other_user&#125;"</span>,</div><div class="line">    <span class="attr">"gists_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/gists&#123;/gist_id&#125;"</span>,</div><div class="line">    <span class="attr">"starred_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/starred&#123;/owner&#125;&#123;/repo&#125;"</span>,</div><div class="line">    <span class="attr">"subscriptions_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/subscriptions"</span>,</div><div class="line">    <span class="attr">"organizations_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/orgs"</span>,</div><div class="line">    <span class="attr">"repos_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/repos"</span>,</div><div class="line">    <span class="attr">"events_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/events&#123;/privacy&#125;"</span>,</div><div class="line">    <span class="attr">"received_events_url"</span>: <span class="string">"https://api.github.com/users/nicowilliams/received_events"</span>,</div><div class="line">    <span class="attr">"type"</span>: <span class="string">"User"</span>,</div><div class="line">    <span class="attr">"site_admin"</span>: <span class="literal">false</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"parents"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"sha"</span>: <span class="string">"2fb099e4cfe5a9fedd55a1ace44ae2c5ee02cb12"</span>,</div><div class="line">      <span class="attr">"url"</span>: <span class="string">"https://api.github.com/repos/stedolan/jq/commits/2fb099e4cfe5a9fedd55a1ace44ae2c5ee02cb12"</span>,</div><div class="line">      <span class="attr">"html_url"</span>: <span class="string">"https://github.com/stedolan/jq/commit/2fb099e4cfe5a9fedd55a1ace44ae2c5ee02cb12"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>自定义格式输出某一项 jq ‘.[0] | {message: .commit.message, name: .commit.committer.name}’<br>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"> 		<span class="attr">"message"</span>: <span class="string">"Add more missing math functions"</span>,</div><div class="line"> 		<span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<p>这里 | 后面的内容是以前面的内容为输入的，.commit 中的 . 就是指 .[0] 中的内容。</p>
<blockquote>
<ul>
<li>自定义格式输出多项<br>
jq ‘.[] | {message: .commit.message, name: .commit.committer.name}’ 也就是如果要指定去数组中的某一项，需要指定一个值，否则就用一个[]标示取所有的，结果是:</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Merge pull request #162 from stedolan/utf8-fixes\n\nUtf8 fixes. Closes #161"</span></div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Reject all overlong UTF8 sequences."</span></div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Fix various UTF8 parsing bugs.\n\nIn particular, parse bad UTF8 by replacing the broken bits with U+FFFD\nand resychronise correctly after broken sequences."</span></div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Fix example in manual for `floor`. See #155."</span></div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span>,</div><div class="line">  <span class="attr">"message"</span>: <span class="string">"Document floor"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到上边输出不是一个标准的json，修改如下</p>
<blockquote>
<ul>
<li>以数组形式自定义输出多项<br>
jq ‘[.[] | {message: .commit.message, name: .commit.committer.name}]’</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Merge pull request #162 from stedolan/utf8-fixes\n\nUtf8 fixes. Closes #161"</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Reject all overlong UTF8 sequences."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Fix various UTF8 parsing bugs.\n\nIn particular, parse bad UTF8 by replacing the broken bits with U+FFFD\nand resychronise correctly after broken sequences."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Fix example in manual for `floor`. See #155."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Document floor"</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>获取其他内容<br>
jq ‘[.[] | {message: .commit.message, name: .commit.committer.name, parents: [.parents[].html_url]}]’</li>
</ul>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">	[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"parents"</span>: [</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/54b9c9bdb225af5d886466d72f47eafc51acb4f7"</span>,</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/8b1b503609c161fea4b003a7179b3fbb2dd4345a"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Merge pull request #162 from stedolan/utf8-fixes\n\nUtf8 fixes. Closes #161"</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"parents"</span>: [</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/ff48bd6ec538b01d1057be8e93b94eef6914e9ef"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Reject all overlong UTF8 sequences."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"parents"</span>: [</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/54b9c9bdb225af5d886466d72f47eafc51acb4f7"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Fix various UTF8 parsing bugs.\n\nIn particular, parse bad UTF8 by replacing the broken bits with U+FFFD\nand resychronise correctly after broken sequences."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"parents"</span>: [</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/3dcdc582ea993afea3f5503a78a77675967ecdfa"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Stephen Dolan"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Fix example in manual for `floor`. See #155."</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"parents"</span>: [</div><div class="line">      <span class="string">"https://github.com/stedolan/jq/commit/7c4171d414f647ab08bcd20c76a4d8ed68d9c602"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"Nicolas Williams"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"Document floor"</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>这里用 .parents[].html_url 获取当前项的 parents 节点中的所有项的 html_url 属性的内容，然后两边加个中括号组装成数组输出。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="jingchen" />
          <p class="site-author-name" itemprop="name">jingchen</p>
           
              <p class="site-description motion-element" itemprop="description">靖哥哥的技术博客</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jingchen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhanliqing"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
